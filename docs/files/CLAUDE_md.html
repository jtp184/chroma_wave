<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>CLAUDE.md</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>CLAUDE.md
</h1>
<div class='paths'>
CLAUDE.md
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<span id="label-Agent+Guide" class="legacy-anchor"></span>
<h1 id="agent-guide"><a href="#agent-guide">Agent Guide</a></h1>

<span id="label-Project+Overview" class="legacy-anchor"></span>
<h2 id="project-overview"><a href="#project-overview">Project Overview</a></h2>

<p>This project is a gem which binds the C code that drives Waveshare E-Paper displays, providing a simple and intuitive Ruby interface for rendering content on the display.</p>

<span id="label-Goals" class="legacy-anchor"></span>
<h3 id="goals"><a href="#goals">Goals</a></h3>
<ul><li>
<p>Full coverage of the Waveshare E-Paper display functionality, including all supported display models and features.</p>
</li><li>
<p>A clean, idiomatic Ruby API that abstracts away the complexities of the underlying C code and hardware interactions.</p>
</li><li>
<p>Efficient and legible C code that adheres to best practices for C extensions in Ruby, maximizing performance while maintaining readability and maintainability.</p>
</li><li>
<p>Support for advanced image and color transformations out of the box, to allow users to easily manipulate images before rendering them on the display.</p>
</li><li>
<p>Comprehensive documentation and examples to help users get started quickly and understand how to use the gem effectively.</p>
</li></ul>

<span id="label-Guiding+Principles" class="legacy-anchor"></span>
<h2 id="guiding-principles"><a href="#guiding-principles">Guiding Principles</a></h2>

<span id="label-Project+Guidelines" class="legacy-anchor"></span>
<h3 id="project-guidelines"><a href="#project-guidelines">Project Guidelines</a></h3>
<ul><li>
<p>This is a greenfield project:</p>
</li><li>
<p>NEVER worry about “backwards compatible” changes</p>
</li><li>
<p>Make decisive and total refactors whenever necessary</p>
</li><li>
<p>Dont be afraid to throw away code that isnt used or isn’t working.</p>
</li><li>
<p>This is a hardware project:</p>
</li><li>
<p>Always consider the hardware implications of design and implementation decisions.</p>
</li><li>
<p>Use mocks and stubs to allow simulation of hardware interactions in test</p>
</li><li>
<p>But additionally validate designs with end-to-end tests on real hardware whenever possible.</p>
</li></ul>

<span id="label-Orchestration+and+team+management" class="legacy-anchor"></span>
<h3 id="orchestration-and-team-management"><a href="#orchestration-and-team-management">Orchestration and team management</a></h3>
<ul><li>
<p>Create and use teammates as needed</p>
</li><li>
<p>Use Tasks to manage work and coordinate between agents</p>
</li><li>
<p>Include subject-matter expert agents to validate designs beyond just the code</p>
</li></ul>

<span id="label-Design+and+Planning" class="legacy-anchor"></span>
<h3 id="design-and-planning"><a href="#design-and-planning">Design and Planning</a></h3>
<ul><li>
<p>Always start with a design and plan before writing code.</p>
</li><li>
<p>Interview the user as the product owner as needed to ensure the design is solving the right problem, and to gather requirements.</p>
</li><li>
<p>Plans should include acceptance criteria and a clear definition of done.</p>
</li><li>
<p>Always use the actual plan tool when planning, so the plan is persisted where it can be easily referenced and updated as needed.</p>
</li><li>
<p>Reference specific files, classes, and methods in the design.</p>
</li><li>
<p>Always validate designs for Correctness, Clarity, bugs &amp; edge cases, and excellence.</p>
</li><li>
<p>Present options / tradeoffs of stack choices to the human as part of planning</p>
</li><li>
<p>Use the SPARC methodology when devising features</p>
</li><li>
<p>Include visual diagrams in designs when apropriate to clarify complex interactions and structures.</p>
</li><li>
<p>Use Emoji to deleneate sections and make designs more readable and engaging.</p>
</li></ul>

<span id="label-Git+-26+Github" class="legacy-anchor"></span>
<h3 id="git--github"><a href="#git--github">Git &amp; Github</a></h3>
<ul><li>
<p>Use the <code>pull_request_template.md</code> template for PR descriptions. Fill out all sections.</p>
</li><li>
<p>Commit work often to checkpoint progress and allow quick rollback. Git is free!</p>
</li><li>
<p>Use small conventional commits, e.g.‘feat: Improved workflow’, ‘ci: rubocop fixes’, ‘refactor: Simplified adapter with DRY inheritance’</p>
</li></ul>

<span id="label-Infrastructure" class="legacy-anchor"></span>
<h3 id="infrastructure"><a href="#infrastructure">Infrastructure</a></h3>
<ul><li>
<p>Use Github Actions for CI/CD to automate testing and deployment processes</p>
</li></ul>

<span id="label-Software+Development+Best+Practices" class="legacy-anchor"></span>
<h3 id="software-development-best-practices"><a href="#software-development-best-practices">Software Development Best Practices</a></h3>
<ul><li>
<p>Prefer composition over inheritance.</p>
</li><li>
<p>Favor small classes and methods. Single Responsibility Principle.</p>
</li><li>
<p>Depend on abstractions, not concretions.</p>
</li><li>
<p>Write code that is easy to change. Anticipate future requirements.</p>
</li><li>
<p>Use tests to drive design. Write tests that are easy to read and maintain.</p>
</li><li>
<p>Refactor mercilessly. Continuously improve code quality.</p>
</li><li>
<p>Prefer duck typing over rigid type hierarchies.</p>
</li><li>
<p>Use dependency injection to manage dependencies.</p>
</li></ul>

<span id="label-Ruby" class="legacy-anchor"></span>
<h3 id="ruby"><a href="#ruby">Ruby</a></h3>
<ul><li>
<p>Write modern, idiomatic Ruby code. Use newer language features where appropriate.</p>
</li><li>
<p>Use standard gems and tools, don’t reinvent the wheel for common patterns with well established solutions.</p>
</li><li>
<p>One class or module per file. File names should match class/module names. Error subclasses can be grouped with their parent.</p>
</li><li>
<p>Use conventional mixins like <code>Enumerable</code>, <code>Forwardable</code>, and standard method names like succ, call, to_h, etc. to integrate with other Ruby code cleanly.</p>
</li><li>
<p>Make apropriate use of inheritance and modules to promote code reuse. DRY!</p>
</li><li>
<p>Use keyword argument over positional arguments whenever appropriate.</p>
</li><li>
<p>Use <code>attr_accessor</code> and related methods to define getters and setters.</p>
</li><li>
<p>Use private accessors for reading internal state, never instance variables directly.</p>
</li><li>
<p>initialize is the exception, where instance variables can be set directly.</p>
</li><li>
<p>Metaprogramming is good, but avoid overusing it to the point where code becomes hard to understand.</p>
</li><li>
<p><code>define_method</code> for <code>?</code> methods off of enumurated values is good</p>
</li><li>
<p><code>method_missing</code> to dynamically handle all method calls is bad, use explicit forwarding / delegation</p>
</li><li>
<p>Make use of <code>tap</code> and <code>then</code> to avoid temporary variables when appropriate.</p>
</li><li>
<p>Use <code>when...then...</code> syntax with single-line case statements for conciseness</p>
</li><li>
<p>Use Constants for regular expressions, and use <code>/x</code> mode for complex regexes</p>
</li><li>
<p>Any given line of feature code will do one of 4 things:</p>
</li><li>
<p>Collecting input</p>
<ul><li>
<p>Use keyword arguments to assert required inputs and provide defaults.</p>
</li><li>
<p>Prefer value objects over primitive types. Encapsulate behavior with data.</p>
</li><li>
<p>Provide clear interfaces for input. Use parameter builders when apropriate.</p>
</li><li>
<p>Use <code>Array()</code> and other conversion methods to handle flexible input types.</p>
</li><li>
<p>Define conversion functions where apropriate</p>
</li></ul>
</li><li>
<p>Performing work</p>
</li><li>
<p>Delivering output</p>
<ul><li>
<p>Handle special cases with a guard clause</p>
</li></ul>
</li><li>
<p>Handling errors</p>
<ul><li>
<p>Prefer top-level <code>rescue</code> clauses for error handling.</p>
</li></ul>
</li></ul>

<span id="label-RSpec-2C+Rubocop-2C+-26+RDoc" class="legacy-anchor"></span>
<h3 id="rspec-rubocop--rdoc"><a href="#rspec-rubocop--rdoc">RSpec, Rubocop, &amp; RDoc</a></h3>
<ul><li>
<p>Exercise control over the test environment with gems like <code>Timecop</code>, <code>FakeFS</code>, and <code>WebMock</code> to isolate tests from and document external dependencies.</p>
</li><li>
<p>Test regularly to ensure correctness. Use <code>--fail-fast</code> to get feedback quickly</p>
</li><li>
<p>Always fix all specs and linting offenses before merging. Don’t merge broken code even if it seems to be preexisting.</p>
</li><li>
<p>Follow the linter’s guidance. Ignore rubocop rules only as a last resort, and always with a comment explaining why.</p>
</li><li>
<p>If the linter rule is wrong, propose a change to the linter configuration, don’t just add one-off exceptions.</p>
</li><li>
<p>Propose custom linter rules if there are common patterns in the codebase that the default rules don’t cover.</p>
</li><li>
<p>Use RDoc to document public <em>and private</em> methods. Document parameters, return values, and any side effects or exceptions raised. Use YARD tags for complex cases.</p>
</li></ul>

<span id="label-C+Extension+Code" class="legacy-anchor"></span>
<h3 id="c-extension-code"><a href="#c-extension-code">C Extension Code</a></h3>

<span id="label-Basics" class="legacy-anchor"></span>
<h3 id="basics"><a href="#basics">Basics</a></h3>
<ul><li>
<p>C method functions <strong>must</strong> return <code>VALUE</code> and take <code>VALUE self</code> as first arg.</p>
</li><li>
<p>Avoid storing <code>VALUE</code>s in C data when possible; it’s error-prone.</p>
</li><li>
<p>API naming pattern: modules <code>rb_mX</code>, classes <code>rb_cX</code>, exceptions <code>rb_eX</code>.</p>
</li><li>
<p>Follow Ruby conventions: classes/modules <code>UpperCamel</code>, methods <code>snake_case</code>, ivars <code>@prefixed</code>, globals <code>$prefixed</code>.</p>
</li><li>
<p>Three argument styles:</p>
</li><li>
<p><strong>Fixed args</strong> (0–16): <code>VALUE meth(VALUE self, VALUE arg1, VALUE arg2)</code> → define with <code>argc = 2</code></p>
</li><li>
<p><strong>C array (varargs):</strong> <code>VALUE meth(int argc, VALUE* argv, VALUE self)</code> → define with <code>argc = -1</code></p>
</li><li>
<p><strong>Ruby Array:</strong> <code>VALUE meth(VALUE self, VALUE args)</code> → define with <code>argc = -2</code></p>
</li><li>
<p>Use <code>rb_scan_args(argc, argv, &quot;21*:&amp;&quot;, ...)</code> to parse optional, splat, keyword, and block args. Set defaults manually for optional args (<code>NIL_P(opt) ? default : opt</code>).</p>
</li><li>
<p>Register with <code>rb_define_method(klass, &quot;name&quot;, func, argc)</code>. Use <code>_private_method</code>, <code>_protected_method</code>, <code>_singleton_method</code>, <code>_module_function</code> variants as needed.</p>
</li><li>
<p>Use <code>TypedData_Wrap_Struct</code> / <code>TypedData_Make_Struct</code> (not the legacy <code>Data_Wrap_Struct</code>).</p>
</li><li>
<p>Always define a <code>rb_data_type_t</code> struct with:</p>
</li><li>
<p><code>dfree</code>: frees your C data (or <code>RUBY_DEFAULT_FREE</code> if a plain <code>free()</code> suffices).</p>
</li><li>
<p><code>dsize</code>: reports memory usage to Ruby — always implement this.</p>
</li><li>
<p><code>dmark</code>: <strong>required</strong> if your C struct holds any <code>VALUE</code>s — call <code>rb_gc_mark()</code> on each one.</p>
</li><li>
<p>Set <code>flags = RUBY_TYPED_FREE_IMMEDIATELY</code> unless <code>dfree</code> releases the GVL.</p>
</li><li>
<p>Use designated initializers (<code>{ .wrap_struct_name = &quot;foo&quot;, ... }</code>) to zero out unused fields.</p>
</li><li>
<p>Separate allocation (<code>rb_define_alloc_func</code>) from initialization (<code>initialize</code> method).</p>
</li><li>
<p>Extract data with <code>TypedData_Get_Struct(obj, CType, &amp;type_struct, ptr)</code>.</p>
</li><li>
<p>The Ruby VM is <strong>not thread-safe</strong>. Never call API functions from multiple C threads simultaneously.</p>
</li><li>
<p>All C code exposed to Ruby runs under the GVL (Global VM Lock) by default — it blocks other Ruby threads.</p>
</li><li>
<p>For long-running C computation that doesn’t use the API: release the GVL with <code>rb_thread_call_without_gvl(func, arg, ubf, ubf_arg)</code> (requires <code>#include &lt;ruby/thread.h&gt;</code>).</p>
</li><li>
<p>Provide an unblocking function (<code>ubf</code>) for interruptibility, or use <code>RUBY_UBF_IO</code> for simple cases.</p>
</li><li>
<p>To temporarily reacquire the GVL from an unlocked thread: <code>rb_thread_call_with_gvl(func, arg)</code>.</p>
</li></ul>

<span id="label-Gotchas" class="legacy-anchor"></span>
<h3 id="gotchas"><a href="#gotchas">Gotchas</a></h3>
<ul><li>
<p>NUM2UINT and friends don’t raise on negative values. All the unsigned conversion macros silently accept negatives. This is confirmed not-a-bug by Ruby core.</p>
</li><li>
<p>NUM2CHR has two quirks: it only range-checks against int (not char), and passing a string returns the first character’s numeric value instead of raising TypeError.</p>
</li><li>
<p>Invalid names are silently created and invisible. rb_define_class(rb_cObject, “foo”, …) won’t error — it just makes a class Ruby code can never access. Same for ivars without @, etc.</p>
</li><li>
<p>Qnil is truthy in C. Only Qfalse is C-falsy (0). You must use RTEST() or NIL_P() — a bare if (value) check will treat nil as true.</p>
</li><li>
<p>Qundef will segfault the VM if it ends up where Ruby expects a normal VALUE. It’s only safe in a couple of narrow contexts (yielding nothing, unsetting constants).</p>
</li><li>
<p>rb_eval_string runs in an isolated binding, unlike Ruby’s eval. Local variables aren’t shared in either direction.</p>
</li><li>
<p>rb_rescue2 needs a trailing 0 sentinel. It’s varargs — omit the 0 after your exception class list and you get undefined behavior.</p>
</li><li>
<p>You must manually clear $! after rescuing: rb_set_errinfo(Qnil). The docs imply it’s sometimes auto-cleared but in practice it never is.</p>
</li><li>
<p>dmark isn’t optional “just for safety” — if your wrapped struct holds any VALUE and you skip it, the GC will collect those objects out from under you on the next sweep. This is the single most common C extension memory bug.</p>
</li><li>
<p>PRIsVALUE hijacks the %i specifier in rb_sprintf. So when printing an actual int, use %d — %i will be interpreted as a VALUE and likely crash.</p>
</li><li>
<p><strong>Never use <code>rb_eval_string()</code></strong> unless there is no API equivalent. It invokes the parser, is slow, and defeats the purpose of writing C.</p>
</li></ul>

<span id="label-Defining+Classes-2C+Modules-2C+and+Structure" class="legacy-anchor"></span>
<h3 id="defining-classes-modules-and-structure"><a href="#defining-classes-modules-and-structure">Defining Classes, Modules, and Structure</a></h3>
<ul><li>
<p><code>rb_define_module(&quot;Foo&quot;)</code> / <code>rb_define_module_under(outer, &quot;Bar&quot;)</code></p>
</li><li>
<p><code>rb_define_class(&quot;Foo&quot;, rb_cObject)</code> / <code>rb_define_class_under(outer, &quot;Bar&quot;, superclass)</code></p>
</li><li>
<p><code>rb_include_module</code>, <code>rb_prepend_module</code>, <code>rb_extend_object</code> for mixins.</p>
</li><li>
<p><code>rb_define_const(module, &quot;NAME&quot;, value)</code> for constants.</p>
</li><li>
<p><code>rb_define_attr(klass, &quot;name&quot;, read, write)</code> for accessors.</p>
</li></ul>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
