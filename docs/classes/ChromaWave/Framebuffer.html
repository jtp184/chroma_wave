<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>ChromaWave::Framebuffer</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>class</span>
ChromaWave::Framebuffer
</h1>
<ol class='paths'>
<li>
<a href="../../files/ext/chroma_wave/chroma_wave_c.html">ext/chroma_wave/chroma_wave.c</a>
</li>
</ol>
<div class='parent'>
Superclass:
<strong>Object</strong>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'></div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-new">new</a></li>
</ol>
<h3>Public Instance</h3>
<ol>
<li><a href="#method-i-3D-3D">==</a></li>
<li><a href="#method-i-buffer_size">buffer_size</a></li>
<li><a href="#method-i-bytes">bytes</a></li>
<li><a href="#method-i-clear">clear</a></li>
<li><a href="#method-i-get_pixel">get_pixel</a></li>
<li><a href="#method-i-height">height</a></li>
<li><a href="#method-i-initialize_copy">initialize_copy</a></li>
<li><a href="#method-i-inspect">inspect</a></li>
<li><a href="#method-i-pixel_format">pixel_format</a></li>
<li><a href="#method-i-set_pixel">set_pixel</a></li>
<li><a href="#method-i-width">width</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-new'>
<a name='method-c-new'></a>
<div class='synopsis'>
<span class='name'>new</span><span class='arguments'>(p1, p2, p3)</span>

</div>
<div class='description'>

<p>—- Initialize —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-new-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-new-source'>static VALUE
fb_initialize(VALUE self, VALUE rb_width, VALUE rb_height, VALUE rb_format)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);

    int w = NUM2INT(rb_width);
    int h = NUM2INT(rb_height);

    if (w &lt;= 0 || w &gt; EPD_MAX_DIMENSION)
        rb_raise(rb_eArgError, &quot;width must be between 1 and %d&quot;, EPD_MAX_DIMENSION);
    if (h &lt;= 0 || h &gt; EPD_MAX_DIMENSION)
        rb_raise(rb_eArgError, &quot;height must be between 1 and %d&quot;, EPD_MAX_DIMENSION);

    fb-&gt;width       = (uint16_t)w;
    fb-&gt;height      = (uint16_t)h;
    fb-&gt;pixel_format = cw_sym_to_pixel_format(rb_format);
    fb-&gt;width_byte  = calc_width_byte(fb-&gt;width, fb-&gt;pixel_format);
    fb-&gt;buffer_size = (size_t)fb-&gt;width_byte * fb-&gt;height;

    fb-&gt;buffer = (uint8_t *)xmalloc(fb-&gt;buffer_size);

    /* MONO defaults to white (all bits set), others to 0x00 */
    if (fb-&gt;pixel_format == PIXEL_FORMAT_MONO)
        memset(fb-&gt;buffer, 0xFF, fb-&gt;buffer_size);
    else
        memset(fb-&gt;buffer, 0x00, fb-&gt;buffer_size);

    return self;
}</pre>
</div>
</div>
<h2>Public Instance methods</h2>
<div class='method public-instance' id='method-method-i-3D-3D'>
<a name='method-i-3D-3D'></a>
<div class='synopsis'>
<span class='name'>==</span><span class='arguments'>(p1)</span>

</div>
<div class='description'>

<p>—- equality —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-3D-3D-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-3D-3D-source'>static VALUE
fb_eq(VALUE self, VALUE other)
{
    framebuffer_t *fb_a, *fb_b;

    if (!rb_typeddata_is_kind_of(other, &amp;framebuffer_type))
        return Qfalse;

    TypedData_Get_Struct(self,  framebuffer_t, &amp;framebuffer_type, fb_a);
    TypedData_Get_Struct(other, framebuffer_t, &amp;framebuffer_type, fb_b);

    if (fb_a-&gt;width != fb_b-&gt;width ||
        fb_a-&gt;height != fb_b-&gt;height ||
        fb_a-&gt;pixel_format != fb_b-&gt;pixel_format)
        return Qfalse;

    if (memcmp(fb_a-&gt;buffer, fb_b-&gt;buffer, fb_a-&gt;buffer_size) != 0)
        return Qfalse;

    return Qtrue;
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-buffer_size'>
<a name='method-i-buffer_size'></a>
<div class='synopsis'>
<span class='name'>buffer_size</span><span class='arguments'>()</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-buffer_size-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-buffer_size-source'>static VALUE
fb_buffer_size(VALUE self)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);
    return SIZET2NUM(fb-&gt;buffer_size);
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-bytes'>
<a name='method-i-bytes'></a>
<div class='synopsis'>
<span class='name'>bytes</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>—- bytes —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-bytes-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-bytes-source'>static VALUE
fb_bytes(VALUE self)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);

    VALUE str = rb_str_new((const char *)fb-&gt;buffer, (long)fb-&gt;buffer_size);
    rb_enc_associate(str, rb_ascii8bit_encoding());
    OBJ_FREEZE(str);
    return str;
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-clear'>
<a name='method-i-clear'></a>
<div class='synopsis'>
<span class='name'>clear</span><span class='arguments'>(p1)</span>

</div>
<div class='description'>

<p>—- clear(color) —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-clear-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-clear-source'>static VALUE
fb_clear(VALUE self, VALUE rb_color)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);

    uint8_t c = (uint8_t)(NUM2INT(rb_color) &amp; 0xFF);
    uint8_t fill;

    switch (fb-&gt;pixel_format) {
    case PIXEL_FORMAT_MONO:
        fill = (c == 0) ? 0x00 : 0xFF;
        break;
    case PIXEL_FORMAT_GRAY4:
        c = c &amp; 0x03;
        fill = (uint8_t)((c &lt;&lt; 6) | (c &lt;&lt; 4) | (c &lt;&lt; 2) | c);
        break;
    case PIXEL_FORMAT_COLOR4:
    case PIXEL_FORMAT_COLOR7:
        c = c &amp; 0x0F;
        fill = (uint8_t)((c &lt;&lt; 4) | c);
        break;
    default:
        fill = 0x00;
        break;
    }

    memset(fb-&gt;buffer, fill, fb-&gt;buffer_size);
    return self;
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-get_pixel'>
<a name='method-i-get_pixel'></a>
<div class='synopsis'>
<span class='name'>get_pixel</span><span class='arguments'>(p1, p2)</span>

</div>
<div class='description'>

<p>—- <a href="Framebuffer.html#method-i-get_pixel"><code>get_pixel</code></a>(x, y) —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-get_pixel-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-get_pixel-source'>static VALUE
fb_get_pixel(VALUE self, VALUE rb_x, VALUE rb_y)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);

    int x = NUM2INT(rb_x);
    int y = NUM2INT(rb_y);

    /* nil for out-of-bounds */
    if (x &lt; 0 || x &gt;= fb-&gt;width || y &lt; 0 || y &gt;= fb-&gt;height)
        return Qnil;

    size_t addr;
    uint8_t rdata, color;

    switch (fb-&gt;pixel_format) {
    case PIXEL_FORMAT_MONO:
        addr = (size_t)(x / 8) + (size_t)y * fb-&gt;width_byte;
        rdata = fb-&gt;buffer[addr];
        color = (rdata &gt;&gt; (7 - (x % 8))) &amp; 0x01;
        return INT2NUM(color);

    case PIXEL_FORMAT_GRAY4:
        addr = (size_t)(x / 4) + (size_t)y * fb-&gt;width_byte;
        rdata = fb-&gt;buffer[addr];
        color = (rdata &gt;&gt; (6 - (x % 4) * 2)) &amp; 0x03;
        return INT2NUM(color);

    case PIXEL_FORMAT_COLOR4:
    case PIXEL_FORMAT_COLOR7:
        addr = (size_t)(x / 2) + (size_t)y * fb-&gt;width_byte;
        rdata = fb-&gt;buffer[addr];
        color = (rdata &gt;&gt; (4 - (x % 2) * 4)) &amp; 0x0F;
        return INT2NUM(color);
    }

    return Qnil; /* unreachable */
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-height'>
<a name='method-i-height'></a>
<div class='synopsis'>
<span class='name'>height</span><span class='arguments'>()</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-height-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-height-source'>static VALUE
fb_height(VALUE self)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);
    return INT2NUM(fb-&gt;height);
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-initialize_copy'>
<a name='method-i-initialize_copy'></a>
<div class='synopsis'>
<span class='name'>initialize_copy</span><span class='arguments'>(p1)</span>

</div>
<div class='description'>

<p>—- <a href="Framebuffer.html#method-i-initialize_copy"><code>initialize_copy</code></a> (deep-copy for dup/clone) —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-initialize_copy-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-initialize_copy-source'>static VALUE
fb_initialize_copy(VALUE copy, VALUE orig)
{
    framebuffer_t *fb_copy, *fb_orig;

    if (copy == orig) return copy;

    TypedData_Get_Struct(copy, framebuffer_t, &amp;framebuffer_type, fb_copy);
    TypedData_Get_Struct(orig, framebuffer_t, &amp;framebuffer_type, fb_orig);

    /* Free any existing buffer in the copy */
    if (fb_copy-&gt;buffer) {
        xfree(fb_copy-&gt;buffer);
        fb_copy-&gt;buffer = NULL;
    }

    /* Copy metadata */
    fb_copy-&gt;width        = fb_orig-&gt;width;
    fb_copy-&gt;height       = fb_orig-&gt;height;
    fb_copy-&gt;pixel_format = fb_orig-&gt;pixel_format;
    fb_copy-&gt;width_byte   = fb_orig-&gt;width_byte;
    fb_copy-&gt;buffer_size  = fb_orig-&gt;buffer_size;

    /* Deep-copy buffer data */
    if (fb_orig-&gt;buffer &amp;&amp; fb_orig-&gt;buffer_size &gt; 0) {
        fb_copy-&gt;buffer = (uint8_t *)xmalloc(fb_orig-&gt;buffer_size);
        memcpy(fb_copy-&gt;buffer, fb_orig-&gt;buffer, fb_orig-&gt;buffer_size);
    }

    return copy;
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-inspect'>
<a name='method-i-inspect'></a>
<div class='synopsis'>
<span class='name'>inspect</span><span class='arguments'>()</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-inspect-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-inspect-source'>static VALUE
fb_inspect(VALUE self)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);

    return rb_sprintf(&quot;#&lt;ChromaWave::Framebuffer %dx%d %s (%&quot;PRIuSIZE&quot; bytes)&gt;&quot;,
                      fb-&gt;width, fb-&gt;height,
                      pixel_format_name(fb-&gt;pixel_format),
                      fb-&gt;buffer_size);
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-pixel_format'>
<a name='method-i-pixel_format'></a>
<div class='synopsis'>
<span class='name'>pixel_format</span><span class='arguments'>()</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-pixel_format-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-pixel_format-source'>static VALUE
fb_pixel_format(VALUE self)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);
    return cw_pixel_format_to_sym(fb-&gt;pixel_format);
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-set_pixel'>
<a name='method-i-set_pixel'></a>
<div class='synopsis'>
<span class='name'>set_pixel</span><span class='arguments'>(p1, p2, p3)</span>

</div>
<div class='description'>

<p>—- <a href="Framebuffer.html#method-i-set_pixel"><code>set_pixel</code></a>(x, y, color) —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-set_pixel-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-set_pixel-source'>static VALUE
fb_set_pixel(VALUE self, VALUE rb_x, VALUE rb_y, VALUE rb_color)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);

    int x = NUM2INT(rb_x);
    int y = NUM2INT(rb_y);

    /* Silent clip on out-of-bounds */
    if (x &lt; 0 || x &gt;= fb-&gt;width || y &lt; 0 || y &gt;= fb-&gt;height)
        return self;

    uint8_t color = (uint8_t)(NUM2INT(rb_color) &amp; 0xFF);
    size_t addr;
    uint8_t rdata;

    switch (fb-&gt;pixel_format) {
    case PIXEL_FORMAT_MONO:
        addr = (size_t)(x / 8) + (size_t)y * fb-&gt;width_byte;
        rdata = fb-&gt;buffer[addr];
        if (color == 0) /* BLACK: clear bit */
            fb-&gt;buffer[addr] = rdata &amp; ~(0x80 &gt;&gt; (x % 8));
        else /* WHITE: set bit */
            fb-&gt;buffer[addr] = rdata | (0x80 &gt;&gt; (x % 8));
        break;

    case PIXEL_FORMAT_GRAY4:
        addr = (size_t)(x / 4) + (size_t)y * fb-&gt;width_byte;
        color = color &amp; 0x03; /* 2-bit color */
        rdata = fb-&gt;buffer[addr];
        rdata = rdata &amp; ~(0xC0 &gt;&gt; ((x % 4) * 2));
        fb-&gt;buffer[addr] = rdata | ((color &lt;&lt; 6) &gt;&gt; ((x % 4) * 2));
        break;

    case PIXEL_FORMAT_COLOR4:
    case PIXEL_FORMAT_COLOR7:
        addr = (size_t)(x / 2) + (size_t)y * fb-&gt;width_byte;
        color = color &amp; 0x0F; /* 4-bit color */
        rdata = fb-&gt;buffer[addr];
        rdata = rdata &amp; ~(0xF0 &gt;&gt; ((x % 2) * 4));
        fb-&gt;buffer[addr] = rdata | ((color &lt;&lt; 4) &gt;&gt; ((x % 2) * 4));
        break;
    }

    return self;
}</pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-width'>
<a name='method-i-width'></a>
<div class='synopsis'>
<span class='name'>width</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>—- Accessors —-</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-width-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-width-source'>static VALUE
fb_width(VALUE self)
{
    framebuffer_t *fb;
    TypedData_Get_Struct(self, framebuffer_t, &amp;framebuffer_type, fb);
    return INT2NUM(fb-&gt;width);
}</pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
